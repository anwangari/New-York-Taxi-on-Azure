{
	"name": "combine-green-and-yellow",
	"properties": {
		"description": "CETAS query to combine the data from green and yellow trips records",
		"content": {
			"query": "CREATE PROCEDURE combine_green_yellow\nAS\nBEGIN\n    -- Check if the file format exists, and create it if not\n    IF NOT EXISTS (SELECT * FROM sys.external_file_formats WHERE name = 'SynapseParquetFormat')\n    BEGIN\n        CREATE EXTERNAL FILE FORMAT [SynapseParquetFormat]\n        WITH (FORMAT_TYPE = PARQUET);\n    END;\n\n    -- Check if the external data source exists, and create it if not\n    IF NOT EXISTS (SELECT * FROM sys.external_data_sources WHERE name = 'new-york-taxi_nytaxidatastore2_dfs_core_windows_net')\n    BEGIN\n        CREATE EXTERNAL DATA SOURCE [new-york-taxi_nytaxidatastore2_dfs_core_windows_net]\n        WITH (\n            LOCATION = 'abfss://new-york-taxi@nytaxidatastore2.dfs.core.windows.net'\n        );\n    END;\n\n    -- Create the external table\n    CREATE EXTERNAL TABLE dbo.combinedtaxitrip\n        WITH (\n            LOCATION = 'combined_trips_data',\n            DATA_SOURCE = [new-york-taxi_nytaxidatastore2_dfs_core_windows_net],\n            FILE_FORMAT = SynapseParquetFormat\n        )\n    AS\n    SELECT \n        VendorID,\n        pickup_datetime,\n        dropoff_datetime,\n        passenger_count,\n        trip_distance,\n        RatecodeID,\n        store_and_fwd_flag,\n        PULocationID,\n        DOLocationID,\n        payment_type,\n        fare_amount,\n        extra,\n        mta_tax,\n        tip_amount,\n        tolls_amount,\n        improvement_surcharge,\n        total_amount,\n        congestion_surcharge,\n        service\n    FROM (\n        SELECT \n            VendorID,\n            lpep_pickup_datetime AS pickup_datetime,\n            lpep_dropoff_datetime AS dropoff_datetime,\n            passenger_count,\n            trip_distance,\n            RatecodeID,\n            store_and_fwd_flag,\n            PULocationID,\n            DOLocationID,\n            payment_type,\n            fare_amount,\n            extra,\n            mta_tax,\n            tip_amount,\n            tolls_amount,\n            improvement_surcharge,\n            total_amount,\n            congestion_surcharge,\n            'green' AS service\n        FROM\n        OPENROWSET(\n            BULK 'https://nytaxidatastore2.dfs.core.windows.net/new-york-taxi/rides/green/*',\n            FORMAT = 'PARQUET'\n        ) AS [green_result]\n        UNION ALL\n        SELECT \n            VendorID,\n            tpep_pickup_datetime AS pickup_datetime,\n            tpep_dropoff_datetime AS dropoff_datetime,\n            passenger_count,\n            trip_distance,\n            RatecodeID,\n            store_and_fwd_flag,\n            PULocationID,\n            DOLocationID,\n            payment_type,\n            fare_amount,\n            extra,\n            mta_tax,\n            tip_amount,\n            tolls_amount,\n            improvement_surcharge,\n            total_amount,\n            congestion_surcharge,\n            'yellow' AS service\n        FROM\n        OPENROWSET(\n            BULK 'https://nytaxidatastore2.dfs.core.windows.net/new-york-taxi/rides/yellow/*',\n            FORMAT = 'PARQUET'\n        ) AS [yellow_result]\n    ) combined_taxi_data;\nEND;\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "NewYorkTaxiDB",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}